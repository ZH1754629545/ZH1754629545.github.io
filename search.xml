<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>spring AI 初步开发</title>
      <link href="/2025/07/15/spring-AI-%E5%88%9D%E6%AD%A5%E5%BC%80%E5%8F%91/"/>
      <url>/2025/07/15/spring-AI-%E5%88%9D%E6%AD%A5%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h1 id="spring-AI-初步开发"><a href="#spring-AI-初步开发" class="headerlink" title="spring AI 初步开发"></a>spring AI 初步开发</h1><h3 id="官方文档-Spring-AI"><a href="#官方文档-Spring-AI" class="headerlink" title="官方文档:Spring AI"></a>官方文档:<a href="https://spring.io/projects/spring-ai">Spring AI</a></h3><p>spring AI 极大的简化了对AI的prompt工程。可以区分为用户(user)，系统(system),助手(assistant) 三个模块。以及Advisor（拦截器）、Tool（工具）、RAG(检索增强) 、MCP(模型上下文协议)等。</p><h3 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目:"></a>初始化项目:</h3><p>​官方文档：<a href="https://springdoc.cn/spring-ai/getting-started.html">入门 :: Spring AI 中文文档</a><br>​注: java版本17以上，这里选择21<br>​</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-ai-bom&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.0</span><span class="number">.0</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">            &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">            &lt;scope&gt;<span class="keyword">import</span>&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--        deepseek 模型--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-ai-starter-model-deepseek&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-ai-advisors-vector-store&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.0</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.esotericsoftware&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;kryo&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">5.6</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: MyAI</span><br><span class="line">  ai:</span><br><span class="line">    deepseek:</span><br><span class="line">      api-key: xxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">      base-url: https:<span class="comment">//api.deepseek.com/v1</span></span><br><span class="line">      chat:</span><br><span class="line">        options:</span><br><span class="line">          model: deepseek-chat</span><br></pre></td></tr></table></figure><p>因为deepseek不支持检索增强所以换了springboot alibaba 的dashscope模型。</p><p>一下是springboot alibaba配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;repositories&gt;</span><br><span class="line">    &lt;repository&gt;</span><br><span class="line">        &lt;id&gt;spring-milestones&lt;/id&gt;</span><br><span class="line">        &lt;name&gt;Spring Milestones&lt;/name&gt;</span><br><span class="line">        &lt;url&gt;https:<span class="comment">//repo.spring.io/milestone&lt;/url&gt;</span></span><br><span class="line">        &lt;snapshots&gt;</span><br><span class="line">            &lt;enabled&gt;<span class="literal">false</span>&lt;/enabled&gt;</span><br><span class="line">        &lt;/snapshots&gt;</span><br><span class="line">    &lt;/repository&gt;</span><br><span class="line"></span><br><span class="line">    &lt;repository&gt;</span><br><span class="line">        &lt;id&gt;aliyunmaven&lt;/id&gt;</span><br><span class="line">        &lt;name&gt;aliyun&lt;/name&gt;</span><br><span class="line">        &lt;url&gt;https:<span class="comment">//maven.aliyun.com/repository/public&lt;/url&gt;</span></span><br><span class="line">    &lt;/repository&gt;</span><br><span class="line">&lt;/repositories&gt;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud.ai&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-ai-alibaba-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.0</span><span class="number">.0</span>-M6<span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.esotericsoftware&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kryo&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">5.6</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-ai-markdown-document-reader&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.0</span><span class="number">.0</span>-M6&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-ai-mcp-client-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.0</span><span class="number">.0</span>-M6&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: AIFaster</span><br><span class="line">  ai:</span><br><span class="line">    dashscope:</span><br><span class="line">      api-key: xxxxxxxxxxxxxxxxxxxx</span><br><span class="line">      chat:</span><br><span class="line">       options:</span><br><span class="line">         model: deepseek-v3</span><br><span class="line">    mcp:</span><br><span class="line">      client:</span><br><span class="line">        enabled: <span class="literal">true</span></span><br><span class="line">        name: mcp-client</span><br><span class="line">        version: <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">        type: SYNC</span><br><span class="line">        request-timeout: <span class="number">60000</span></span><br><span class="line">        stdio:</span><br><span class="line">          servers-configuration: classpath:/mcp-servers.json</span><br></pre></td></tr></table></figure><h3 id="chatModel-和-chatClient"><a href="#chatModel-和-chatClient" class="headerlink" title="chatModel 和 chatClient"></a>chatModel 和 chatClient</h3><blockquote><h4 id="Spring-AI-中的-ChatModel-和-ChatClient"><a href="#Spring-AI-中的-ChatModel-和-ChatClient" class="headerlink" title="Spring AI 中的 ChatModel 和 ChatClient"></a>Spring AI 中的 ChatModel 和 ChatClient</h4><p>在 Spring AI 框架中，<code>ChatModel</code> 和 <code>ChatClient</code> 是与 AI 聊天功能相关的两个重要接口，它们有不同的职责和使用场景。</p><h5 id="ChatModel"><a href="#ChatModel" class="headerlink" title="ChatModel"></a>ChatModel</h5><p><code>ChatModel</code> 是 Spring AI 中用于与 AI 模型交互的核心接口，主要特点包括：</p><ol><li><strong>功能定位</strong>：<ul><li>提供与底层 AI 模型(如 OpenAI、Anthropic 等)的直接交互能力</li><li>支持完整的聊天对话功能，包括多轮对话、系统提示等</li></ul></li><li><strong>主要方法</strong>：<ul><li><code>generate()</code> - 生成聊天响应</li><li><code>generate(Prompt)</code> - 根据提示生成响应</li><li>支持流式和非流式响应</li></ul></li><li><strong>使用场景</strong>：<ul><li>需要精细控制 AI 模型交互时</li><li>需要访问底层模型的高级功能时</li><li>需要直接处理 Prompt 和 Response 对象时</li></ul></li></ol><h5 id="ChatClient"><a href="#ChatClient" class="headerlink" title="ChatClient"></a>ChatClient</h5><p><code>ChatClient</code> 是一个更高级别的抽象接口，主要特点包括：</p><ol><li><strong>功能定位</strong>：<ul><li>提供更简单的 API 用于聊天交互</li><li>隐藏了部分底层复杂性，更适合简单场景</li></ul></li><li><strong>主要方法</strong>：<ul><li><code>call(String message)</code> - 发送消息并获取响应</li><li>通常返回简单的字符串响应</li></ul></li><li><strong>使用场景</strong>：<ul><li>快速实现简单的聊天功能</li><li>不需要复杂配置或高级功能时</li><li>希望简化代码时</li></ul></li></ol></blockquote><p>​–deepseek</p><p>简单来说使用chatModel是直接对AI接口发起请求的角色,而chatClient可以在这之前和之后添加很多方便快捷的操作。<br>直接用chatModel发起请求:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/simple/chat&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">simpleChat</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dashScopeChatModel.call(<span class="keyword">new</span> <span class="title class_">Prompt</span>(DEFAULT_PROMPT)).getResult().getOutput().getText();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置chatClient发送请求:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ChatClient chatClient;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChatModel dashScopeChatModel;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">DashScopeChatModelImpl</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dashScopeChatModel = chatModel;</span><br><span class="line">        <span class="built_in">this</span>.chatClient = ChatClient.builder(<span class="built_in">this</span>.dashScopeChatModel)</span><br><span class="line">                .defaultSystem(<span class="keyword">new</span> <span class="title class_">SimplePrompt</span>().getDefaultPrompt()) <span class="comment">//默认系统消息</span></span><br><span class="line">                .defaultAdvisors(</span><br><span class="line">                <span class="comment">//配置拦截器，比如消息存储，日志拦截等。</span></span><br><span class="line">                )</span><br><span class="line">            <span class="comment">//还可以配置其他许多默认</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">generate</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="type">SimpleResponse</span> <span class="variable">simpleResponse</span> <span class="operator">=</span> chatClient.prompt().advisors(advisor-&gt;advisor.param(CHAT_MEMORY_CONVERSATION_ID_KEY,<span class="string">&quot;002&quot;</span>).param(CHAT_MEMORY_RETRIEVE_SIZE_KEY,<span class="number">100</span>)).advisors(<span class="keyword">new</span> <span class="title class_">QuestionAnswerAdvisor</span>(vectorStore)).tools(toolCallbackProvider).user(message).call().entity(SimpleResponse.class); <span class="comment">//使用entity直接转换成对应类型</span></span><br><span class="line">        <span class="keyword">return</span> simpleResponse.toString();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//流式响应</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;ChatResponse&gt; <span class="title function_">generateStream</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        Flux&lt;ChatResponse&gt; streamWithMetaData = chatClient.prompt().advisors(advisorSpec -&gt; advisorSpec.param(CHAT_MEMORY_CONVERSATION_ID_KEY,<span class="string">&quot;678&quot;</span>).param(CHAT_MEMORY_RETRIEVE_SIZE_KEY,<span class="number">10</span>)).user(message).stream().chatResponse();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> streamWithMetaData;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>######################</p><h3 id="系统-System-、用户-user"><a href="#系统-System-、用户-user" class="headerlink" title="系统(System)、用户(user)"></a>系统(System)、用户(user)</h3><p>系统相当于出了用户发送的内容外你希望这个模块做到什么功能。比如医疗系统的AI就可以在系统那里写上。你是一名资深的医生…..。 用户就是用户发送的内容。</p><h3 id="上下文连续对话-chatMemory"><a href="#上下文连续对话-chatMemory" class="headerlink" title="上下文连续对话(chatMemory)"></a>上下文连续对话(chatMemory)</h3><p><a href="https://springdoc.cn/spring-ai/api/chat-memory.html">聊天记忆 :: Spring AI 中文文档</a></p><p>基于内存可以使用 InMemoryChatMemoryRepository();<br>这里使用了kryo去保存和读取上下文。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">fileDir</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.dir&quot;</span>)+<span class="string">&quot;/chat-memery&quot;</span>;</span><br><span class="line">  <span class="type">ChatMemory</span> <span class="variable">chatMemory</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FileBasedChatMemory</span>(fileDir);</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">DashScopeChatModelImpl</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.chatClient = ChatClient.builder(<span class="built_in">this</span>.dashScopeChatModel)</span><br><span class="line">              .defaultSystem(<span class="keyword">new</span> <span class="title class_">SimplePrompt</span>().getDefaultPrompt())</span><br><span class="line">              .defaultAdvisors(</span><br><span class="line">                  <span class="keyword">new</span> <span class="title class_">MessageChatMemoryAdvisor</span>(chatMemory),</span><br><span class="line">              )</span><br><span class="line">              .build();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>通过参考InMemoryChatMemoryRepository()基于内存的实现方法去实现FileBasedChatMemory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileBasedChatMemory</span> <span class="keyword">implements</span> <span class="title class_">ChatMemory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String BASE_DIR;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Kryo</span> <span class="variable">kryo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Kryo</span>();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        kryo.setRegistrationRequired(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 设置实例化策略</span></span><br><span class="line">        kryo.setInstantiatorStrategy(<span class="keyword">new</span> <span class="title class_">StdInstantiatorStrategy</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造对象时，指定文件保存目录</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileBasedChatMemory</span><span class="params">(String dir)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.BASE_DIR = dir;</span><br><span class="line">        <span class="type">File</span> <span class="variable">baseDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dir);</span><br><span class="line">        <span class="keyword">if</span> (!baseDir.exists()) &#123;</span><br><span class="line">            baseDir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(String conversationId, Message message)</span> &#123;</span><br><span class="line">        ChatMemory.<span class="built_in">super</span>.add(conversationId, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(String conversationId, List&lt;Message&gt; messages)</span> &#123;</span><br><span class="line">        List&lt;Message&gt; conversationMessages = getOrCreateConversation(conversationId);</span><br><span class="line">        conversationMessages.addAll(messages);</span><br><span class="line">        saveConversation(conversationId, conversationMessages);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">get</span><span class="params">(String conversationId, <span class="type">int</span> lastN)</span> &#123;</span><br><span class="line">        List&lt;Message&gt; allMessages = getOrCreateConversation(conversationId);</span><br><span class="line">        <span class="keyword">return</span> allMessages.stream()</span><br><span class="line">                .skip(Math.max(<span class="number">0</span>, allMessages.size()-lastN))</span><br><span class="line">                .toList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> getConversationFile(conversationId);</span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            file.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Message&gt; <span class="title function_">getOrCreateConversation</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> getConversationFile(conversationId);</span><br><span class="line">        List&lt;Message&gt; messages = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Input</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Input</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file))) &#123;</span><br><span class="line">                messages = kryo.readObject(input, ArrayList.class);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> messages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveConversation</span><span class="params">(String conversationId, List&lt;Message&gt; messages)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> getConversationFile(conversationId);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Output</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Output</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file))) &#123;</span><br><span class="line">            kryo.writeObject(output, messages);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File <span class="title function_">getConversationFile</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(BASE_DIR, conversationId + <span class="string">&quot;.kryo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>最后在chatClient发送请求时添加对应的上下文记忆大小，对话id等即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chatClient.prompt().advisors(advisor-&gt;advisor.param(CHAT_MEMORY_CONVERSATION_ID_KEY,<span class="string">&quot;002&quot;</span>).param(CHAT_MEMORY_RETRIEVE_SIZE_KEY,<span class="number">100</span>))</span><br></pre></td></tr></table></figure><h3 id="Advisor（拦截器）"><a href="#Advisor（拦截器）" class="headerlink" title="Advisor（拦截器）"></a>Advisor（拦截器）</h3><p><a href="https://springdoc.cn/spring-ai/api/advisors.html">Advisor API :: Spring AI 中文文档</a></p><p>用于在发起请求前后做的操作。</p><h4 id="日志拦截器-用于日志输出发送和返回的propt和response"><a href="#日志拦截器-用于日志输出发送和返回的propt和response" class="headerlink" title="日志拦截器(用于日志输出发送和返回的propt和response)"></a>日志拦截器(用于日志输出发送和返回的propt和response)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.chatClient = ChatClient.builder(<span class="built_in">this</span>.dashScopeChatModel)</span><br><span class="line">        .defaultSystem(<span class="keyword">new</span> <span class="title class_">SimplePrompt</span>().getDefaultPrompt())</span><br><span class="line">        .defaultAdvisors(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">MyLoggerAdvisor</span>()</span><br><span class="line">        )</span><br></pre></td></tr></table></figure><p>​</p><p>实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLoggerAdvisor</span> <span class="keyword">implements</span> <span class="title class_">CallAroundAdvisor</span>, StreamAroundAdvisor &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AdvisedResponse <span class="title function_">aroundCall</span><span class="params">(AdvisedRequest advisedRequest, CallAroundAdvisorChain chain)</span> &#123;</span><br><span class="line">        advisedRequest = <span class="built_in">this</span>.before(advisedRequest);</span><br><span class="line">        <span class="type">AdvisedResponse</span> <span class="variable">advisedResponse</span> <span class="operator">=</span> chain.nextAroundCall(advisedRequest);</span><br><span class="line">        <span class="built_in">this</span>.observeAfter(advisedResponse);</span><br><span class="line">        <span class="keyword">return</span> advisedResponse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;AdvisedResponse&gt; <span class="title function_">aroundStream</span><span class="params">(AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain)</span> &#123;</span><br><span class="line">        advisedRequest = <span class="built_in">this</span>.before(advisedRequest);</span><br><span class="line">        Flux&lt;AdvisedResponse&gt; advisedResponses = chain.nextAroundStream(advisedRequest);</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">MessageAggregator</span>()).aggregateAdvisedResponse(advisedResponses,<span class="built_in">this</span>::observeAfter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> AdvisedRequest <span class="title function_">before</span><span class="params">(AdvisedRequest request)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;AI Request: &#123;&#125;&quot;</span>, request.adviseContext());</span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">observeAfter</span><span class="params">(AdvisedResponse advisedResponse)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;AI Response: &#123;&#125;&quot;</span>, advisedResponse.response().getResult().getOutput().getText());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RAG（检索增强）"><a href="#RAG（检索增强）" class="headerlink" title="RAG（检索增强）"></a>RAG（检索增强）</h3><p><a href="https://springdoc.cn/spring-ai/api/retrieval-augmented-generation.html">检索增强生成 :: Spring AI 中文文档</a></p><p>通过向量存储知识库用来快速匹配到对应内容然后发送给AI。（利用向量的数学方法在空间上快速匹配，离得越近匹配度越高）。<br>这里使用md作为知识库数据<br>引入springai md 读取依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-ai-markdown-document-reader&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.0</span><span class="number">.0</span>-M6&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>配置vector 向量存储</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VectorConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    MyMarkdownReader myMarkdownReader;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> VectorStore <span class="title function_">vectorStore</span><span class="params">(EmbeddingModel embeddingModel)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SimpleVectorStore</span> <span class="variable">simpleVectorStore</span> <span class="operator">=</span> SimpleVectorStore.builder(embeddingModel).build();</span><br><span class="line">        List&lt;Document&gt;markDownDocs =  myMarkdownReader.loadMarkdown(); <span class="comment">//读取本地文件</span></span><br><span class="line">        simpleVectorStore.add(markDownDocs);</span><br><span class="line">        <span class="keyword">return</span> simpleVectorStore;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>读取本地md文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMarkdownReader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourcePatternResolver resourcePatternResolver;</span><br><span class="line"></span><br><span class="line">    MyMarkdownReader(ResourcePatternResolver resourcePatternResolver)&#123;</span><br><span class="line">        <span class="built_in">this</span>.resourcePatternResolver= resourcePatternResolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Document&gt; <span class="title function_">loadMarkdown</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Document&gt; allDocs= <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Resource[] resources = resourcePatternResolver.getResources(<span class="string">&quot;classpath:doc/*.md&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> resource.getFilename();</span><br><span class="line">                <span class="type">MarkdownDocumentReaderConfig</span> <span class="variable">config</span> <span class="operator">=</span> MarkdownDocumentReaderConfig.builder()</span><br><span class="line">                        .withHorizontalRuleCreateDocument(<span class="literal">true</span>)</span><br><span class="line">                        .withIncludeCodeBlock(<span class="literal">false</span>)</span><br><span class="line">                        .withIncludeBlockquote(<span class="literal">false</span>)</span><br><span class="line">                        .withAdditionalMetadata(<span class="string">&quot;filename&quot;</span>, fileName)</span><br><span class="line">                        .build();</span><br><span class="line">                <span class="type">MarkdownDocumentReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MarkdownDocumentReader</span>(resource, config);</span><br><span class="line">                allDocs.addAll(reader.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;加载markdown 文件失败&quot;</span>,e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allDocs;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用时在拦截器advisor里添加QuestionAnswerAdvisor即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> VectorStore vectorStore;</span><br><span class="line">    <span class="type">SimpleResponse</span> <span class="variable">simpleResponse</span> <span class="operator">=</span> chatClient.prompt().advisors(<span class="keyword">new</span> <span class="title class_">QuestionAnswerAdvisor</span>(vectorStore)).user(message).call().entity(SimpleResponse.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="MCP"><a href="#MCP" class="headerlink" title="MCP"></a>MCP</h3><p><a href="https://springdoc.cn/spring-ai/api/mcp/mcp-overview.html">模型上下文协议（MCP） :: Spring AI 中文文档</a></p><p>使用MCP就可以调用其他人基于MCP协议提供的服务.这里就是简单的使用MCP去调用高德地图提供的MCP。</p><p>首先得去高德地图获取key。<a href="https://lbs.amap.com/?ref=https://console.amap.com/dev/flow/manage">高德开放平台 | 高德地图API</a></p><p>引入依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-ai-mcp-client-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.0</span><span class="number">.0</span>-M6&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>修改yml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: AIFaster</span><br><span class="line">  ai:</span><br><span class="line">    dashscope:</span><br><span class="line">      api-key: xxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">      chat:</span><br><span class="line">       options:</span><br><span class="line">         model: deepseek-v3</span><br><span class="line">    mcp:</span><br><span class="line">      client:</span><br><span class="line">        enabled: true</span><br><span class="line">        name: mcp-client</span><br><span class="line">        version: 1.0.0</span><br><span class="line">        type: SYNC</span><br><span class="line">        request-timeout: 60000</span><br><span class="line">        stdio:</span><br><span class="line">          servers-configuration: classpath:/mcp-servers.json</span><br></pre></td></tr></table></figure><p>servers-configuration 里 存放对应key的配置</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;amap-maps&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx.cmd&quot;</span><span class="punctuation">,</span>  <span class="comment">//windows得加.cmd 其他不用</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;-y&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;@amap/amap-maps-mcp-server&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;AMAP_MAPS_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>使用:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ToolCallbackProvider toolCallbackProvider;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateMcp</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> chatClient.prompt().advisors(advisor-&gt;advisor.param(CHAT_MEMORY_CONVERSATION_ID_KEY,<span class="string">&quot;003&quot;</span>).param(CHAT_MEMORY_RETRIEVE_SIZE_KEY,<span class="number">100</span>)).tools(toolCallbackProvider).user(message).call().content();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>效果:</p><p><img src="/%5Cimages%5Cpasted-8.png%5C" alt="upload successful"></p><h3 id="Tool（工具）"><a href="#Tool（工具）" class="headerlink" title="Tool（工具）"></a>Tool（工具）</h3><p><a href="https://docs.spring.io/spring-ai/reference/1.1-SNAPSHOT/api/tools.html#_quick_start">Tool Calling :: Spring AI Reference</a></p><p>除了MCP提供的工具以外也可以自己写工具。<br>&#x2F;&#x2F;TODO</p>]]></content>
      
      
      <categories>
          
          <category> spring AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring AI </tag>
            
            <tag> MCP </tag>
            
            <tag> advisor </tag>
            
            <tag> 向量存储 </tag>
            
            <tag> RAG </tag>
            
            <tag> AI连续对话 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>智能BI项目 (完结？) RabbitMq 消息队列</title>
      <link href="/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE-%E5%AE%8C%E7%BB%93%EF%BC%9F-RabbitMq-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
      <url>/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE-%E5%AE%8C%E7%BB%93%EF%BC%9F-RabbitMq-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<p> 最后主要是做了一个利用RabbitMq 去发布和接收生成图表的任务的工作。</p><p> Q:为什么要用RabbitMq ？用线程池不是已经解决了吗<br> A:在单机开发中线程池 确实能解决一些问题，但是到分布式环境中，使用消息队列可以更加方便的进行开发。因为消息队列可以算是一个跨系统的东西。可以很好的解耦合。而且线程池无法解决优先顺序问题。</p><p><a href="https://juejin.cn/post/7225474899480526885">为什么说前端监控系统离不开 RabbitMQ？前端监控系统是采集用户端的异常、性能、业务埋点等数据上报，在服务端做存储， - 掘金</a></p><h2 id="消息队列："><a href="#消息队列：" class="headerlink" title="消息队列："></a>消息队列：</h2><p>​    我认为的消息队列它拥有可持久化，顺序化，有容错等，有很多方便的工具的东西。</p><h3 id="持久化："><a href="#持久化：" class="headerlink" title="持久化："></a>持久化：</h3><p>​    它可以把数据保存起来，即使重启也没事。并不像缓存那样。</p><h3 id="容错机制："><a href="#容错机制：" class="headerlink" title="容错机制："></a>容错机制：</h3><p>​    他有一个死信队列的东西，专门用来解决如果出错了要怎么处理的方案。</p><h3 id="分配机制："><a href="#分配机制：" class="headerlink" title="分配机制："></a>分配机制：</h3><p>​    rabbitMq 有一个类似与计算机网络交换机，可以根据不同的routingKey（IP地址）去发送生产者的需求给目标消费者的消息队列。</p><h3 id="消息确认机制："><a href="#消息确认机制：" class="headerlink" title="消息确认机制："></a>消息确认机制：</h3><p>​    当消费者接收消息后，可以返回消息(ack、nack、reject） 来告诉消息队列，然后进行相对应的处理。</p><h2 id="实现BI项目消息队列："><a href="#实现BI项目消息队列：" class="headerlink" title="实现BI项目消息队列："></a>实现BI项目消息队列：</h2><p><strong>初始化新的Bi队列</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yupi.springbootinit.bizmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.constant.BiMqConstant;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于创建测试程序用到的交换机和队列（只用在程序启动前执行一次）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BiInitMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建连接工厂</span></span><br><span class="line">            <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">            factory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">            <span class="comment">// 创建通道</span></span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">            <span class="comment">// 定义交换机的名称为&quot;code_exchange&quot;</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> BiMqConstant.BI_EXCHANGE_NAME;</span><br><span class="line">            <span class="comment">// 声明交换机，指定交换机类型为 direct</span></span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建队列，随机分配一个队列名称</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> BiMqConstant.BI_QUEUE_NAME;</span><br><span class="line">            <span class="comment">// 声明队列，设置队列持久化、非独占、非自动删除，并传入额外的参数为 null</span></span><br><span class="line">            channel.queueDeclare(queueName, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 将队列绑定到交换机，指定路由键为 &quot;my_routingKey&quot;</span></span><br><span class="line">            channel.queueBind(queueName, EXCHANGE_NAME, BiMqConstant.BI_ROUTING_KEY);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// 异常处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>生产者</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yupi.springbootinit.bizmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用@Component注解标记该类为一个组件，让Spring框架能够扫描并将其纳入管理</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BiMessageProducer</span> &#123;</span><br><span class="line"><span class="comment">// 使用@Resource注解对rabbitTemplate进行依赖注入</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange   交换机名称，指定消息要发送到哪个交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey 路由键，指定消息要根据什么规则路由到相应的队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message    消息内容，要发送的具体消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String exchange, String routingKey, String message)</span> &#123;</span><br><span class="line">        <span class="comment">// 使用rabbitTemplate的convertAndSend方法将消息发送到指定的交换机和路由键</span></span><br><span class="line">        rabbitTemplate.convertAndSend(exchange, routingKey, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>消费者</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yupi.springbootinit.bizmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.common.ErrorCode;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.constant.BiMqConstant;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.exception.ThrowUtils;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.mapper.ChartMapper;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.model.entity.Chart;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.service.ChartService;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.service.DeepSeekService;</span><br><span class="line"><span class="keyword">import</span> com.yupi.springbootinit.utils.ExcelUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.AmqpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.Header;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用@Component注解标记该类为一个组件，让Spring框架能够扫描并将其纳入管理</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">// 使用@Slf4j注解生成日志记录器</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BiMessageConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    ChartService chartService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    DeepSeekService deepSeekService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收消息的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message      接收到的消息内容，是一个字符串类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel      消息所在的通道，可以通过该通道与 RabbitMQ 进行交互，例如手动确认消息、拒绝消息等</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> deliveryTag  消息的投递标签，用于唯一标识一条消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 使用@SneakyThrows注解简化异常处理</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="comment">// 使用@RabbitListener注解指定要监听的队列名称为&quot;code_queue&quot;，并设置消息的确认机制为手动确认</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;BiMqConstant.BI_QUEUE_NAME&#125;, ackMode = &quot;MANUAL&quot;)</span></span><br><span class="line">    <span class="comment">// @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag是一个方法参数注解,用于从消息头中获取投递标签(deliveryTag),</span></span><br><span class="line">    <span class="comment">// 在RabbitMQ中,每条消息都会被分配一个唯一的投递标签，用于标识该消息在通道中的投递状态和顺序。通过使用@Header(AmqpHeaders.DELIVERY_TAG)注解,可以从消息头中提取出该投递标签,并将其赋值给long deliveryTag参数。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveMessage</span><span class="params">(String message, Channel channel, <span class="meta">@Header(AmqpHeaders.DELIVERY_TAG)</span> <span class="type">long</span> deliveryTag)</span> &#123;</span><br><span class="line">        <span class="comment">// 使用日志记录器打印接收到的消息内容</span></span><br><span class="line">        log.info(<span class="string">&quot;receiveMessage message = &#123;&#125;&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果为空消息</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(message))&#123;</span><br><span class="line">            channel.basicNack(deliveryTag,<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.NOT_FOUND_ERROR,<span class="string">&quot;图表为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取图表</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">chartId</span> <span class="operator">=</span> Long.parseLong(message);</span><br><span class="line">        <span class="type">Chart</span> <span class="variable">chart</span> <span class="operator">=</span> chartService.getById(chartId);</span><br><span class="line"></span><br><span class="line">        ThrowUtils.throwIf(chart==<span class="literal">null</span>,ErrorCode.PARAMS_ERROR,<span class="string">&quot;图表为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行AiChart</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> doAiChart(chart);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span>(!result) &#123;</span><br><span class="line">            channel.basicNack(deliveryTag,<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.SYSTEM_ERROR,<span class="string">&quot;执行AiChart失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;执行AiChart成功&quot;</span>);</span><br><span class="line">        <span class="comment">// 投递标签是一个数字标识,它在消息消费者接收到消息后用于向RabbitMQ确认消息的处理状态。通过将投递标签传递给channel.basicAck(deliveryTag, false)方法,可以告知RabbitMQ该消息已经成功处理,可以进行确认和从队列中删除。</span></span><br><span class="line">        <span class="comment">// 手动确认消息的接收，向RabbitMQ发送确认消息</span></span><br><span class="line">        channel.basicAck(deliveryTag, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">doAiChart</span><span class="params">(Chart chart)</span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//先根据chartId获取图表数据</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">csvData</span> <span class="operator">=</span> chartService.getChartDataByChartId(chart.getId());</span><br><span class="line">           <span class="comment">//处理没有数据情况</span></span><br><span class="line">           ThrowUtils.throwIf(StringUtils.isBlank(csvData),ErrorCode.NOT_FOUND_ERROR,<span class="string">&quot;图表数据找不到&quot;</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//更新chart</span></span><br><span class="line">           <span class="type">Chart</span> <span class="variable">updateChart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chart</span>();</span><br><span class="line">           updateChart.setId(chart.getId());</span><br><span class="line">           <span class="comment">//设置正在执行状态</span></span><br><span class="line">           updateChart.setStatus(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">           <span class="type">boolean</span> <span class="variable">runningUpdate</span> <span class="operator">=</span> chartService.updateById(updateChart);</span><br><span class="line">           ThrowUtils.throwIf(!runningUpdate,ErrorCode.SYSTEM_ERROR,<span class="string">&quot;更新状态running失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//用户输入题词器</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">goal</span> <span class="operator">=</span> chart.getGoal();</span><br><span class="line">           <span class="type">String</span> <span class="variable">chartType</span> <span class="operator">=</span> chart.getChartType();</span><br><span class="line"></span><br><span class="line">           <span class="type">String</span> <span class="variable">userInput</span> <span class="operator">=</span> chartService.getUserInput(goal,chartType,csvData);</span><br><span class="line">           <span class="comment">//发起请求</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> deepSeekService.callDeepSeek(userInput);</span><br><span class="line"></span><br><span class="line">           String[] split = result.split(<span class="string">&quot;【【【【【&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span>(split.length&lt;<span class="number">3</span>)&#123;</span><br><span class="line">               chartService.handleChartUpdateError(chart.getId(),<span class="string">&quot;AI 生成错误&quot;</span>);</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="type">String</span> <span class="variable">genChart</span> <span class="operator">=</span> split[<span class="number">1</span>].trim();</span><br><span class="line">           <span class="type">String</span> <span class="variable">genResult</span> <span class="operator">=</span> split[<span class="number">2</span>].trim();</span><br><span class="line">           <span class="comment">//得到结果后，再更新一次</span></span><br><span class="line">           <span class="type">Chart</span> <span class="variable">updateChartResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chart</span>();</span><br><span class="line">           updateChartResult.setId(chart.getId());</span><br><span class="line">           updateChartResult.setStatus(<span class="string">&quot;succeed&quot;</span>);</span><br><span class="line">           updateChartResult.setGenChart(genChart);</span><br><span class="line">           updateChartResult.setGenResult(genResult);</span><br><span class="line"></span><br><span class="line">           <span class="type">boolean</span> <span class="variable">updateResult</span> <span class="operator">=</span> chartService.updateById(updateChartResult);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span>(!updateResult)&#123;</span><br><span class="line">              chartService.handleChartUpdateError(chart.getId(),<span class="string">&quot;更新图表成功状态失败&quot;</span>);</span><br><span class="line">              <span class="keyword">return</span>  <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 此时只需要将上次做的异步创建中的线程池改成生产者发送需求进入消息队列，然后让消费者去按顺序执行任务即可。</p><p><strong>RabbitMq 有很多不同类型的交换机一个一个说太麻烦了，不如直接贴一个官方教程。以后忘了再看。</strong><br> <a href="https://www.rabbitmq.com/tutorials/tutorial-four-java">RabbitMQ tutorial - Routing | RabbitMQ</a></p>]]></content>
      
      
      <categories>
          
          <category> 智能BI项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMq </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>智能BI项目（五）线程池和队列</title>
      <link href="/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%BA%94%EF%BC%89%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C%E9%98%9F%E5%88%97/"/>
      <url>/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%BA%94%EF%BC%89%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<p> 今天主要是新增了后端的线程池。利用线程池来限制BI项目用户生成AI图表的频率。也就是异步化业务</p><h3 id="异步化任务"><a href="#异步化任务" class="headerlink" title="异步化任务:"></a>异步化任务:</h3><p>​    通过异步操作让需要等待时间长的请求可以异步去完成。比如智能生成图表，如果是同步要等Ai返回则需要等上好久，用户就不能去做其他事情了。此时需要异步化：当用户提交需求时，直接返回已经收到任务结果。但是任务是否正在做需要后端自行解决。</p><h4 id="好处："><a href="#好处：" class="headerlink" title="好处："></a>好处：</h4><p>​        优化了用户的体验（不需要一直等待）。</p><p>​        对于频繁的请求会有限制。(如果没有限制可能会有的问题，那么如果同时来了10几个或者上百个任务，那么调用AI接口会导致第三方API平台直接拒绝你的访问)。</p><h4 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h4><p>​    <strong>用户发送异步请求-&gt;后端-&gt;保存到数据库-&gt;发送到队列-&gt;能处理直接处理返回结果-&gt;不能处理但能入队(没有超过队伍数量最大值)然后等待处理返回结果-&gt;不能入队其他方法(生成失败)；</strong></p><h3 id="使用线程池来完成异步化"><a href="#使用线程池来完成异步化" class="headerlink" title="使用线程池来完成异步化"></a>使用线程池来完成异步化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutorConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">threadPoolExecutor</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ThreadFactory</span> <span class="variable">threadFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">            <span class="comment">//初始线程数</span></span><br><span class="line">            <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//当线程池需要创建线程时就会调用newThread方法</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(<span class="meta">@NotNull</span> Runnable r)</span> &#123;</span><br><span class="line">                <span class="comment">//创建一个线程</span></span><br><span class="line">                <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">                <span class="comment">//设置线程名字</span></span><br><span class="line">                thread.setName(<span class="string">&quot;线程&quot;</span>+count);</span><br><span class="line">                <span class="comment">//线程数量增加</span></span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">return</span> thread;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//创建一个新的线程池</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * @Author: ZH</span></span><br><span class="line"><span class="comment">        * 核心线程数量，最大线程数量，线程存活时间，时间单位,工作队列,线程工厂(管理线程)</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">2</span>, <span class="number">4</span>, <span class="number">100</span>, TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">4</span>),threadFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> threadPoolExecutor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这里使用的时java自带的线程池。给他注册上@bean 并配置</p><p>ThreadPoolExecutor（）中四个参数分别为：核心线程数量，最大线程数量，线程存活时间，时间单位，工作队列，消息工厂。还有一个拒绝策略的参数</p><h4 id="核心线程数量："><a href="#核心线程数量：" class="headerlink" title="核心线程数量："></a>核心线程数量：</h4><p>​    相当于正式员工，有活了都是先给他们干。</p><h4 id="最大线程数量："><a href="#最大线程数量：" class="headerlink" title="最大线程数量："></a>最大线程数量：</h4><p>​    相当于临时工，只有忙不过来的时候才招募（队列满了）</p><h4 id="线程存活时间"><a href="#线程存活时间" class="headerlink" title="线程存活时间:"></a>线程存活时间:</h4><p>​    当用上了最大线程数量时等待请求数量减少到不需要这些临时工时就给他删去。也就是零时工多久没干活了就给它删了</p><h4 id="工作队列："><a href="#工作队列：" class="headerlink" title="工作队列："></a>工作队列：</h4><p>​    队列存储着要等待的任务，所以要设置队列大小。</p><h4 id="消息工厂："><a href="#消息工厂：" class="headerlink" title="消息工厂："></a>消息工厂：</h4><p>​    负责控制每个线程的生成，这里自己新写了一个</p><h4 id="拒绝策略："><a href="#拒绝策略：" class="headerlink" title="拒绝策略："></a>拒绝策略：</h4><p>​    如果队列满了被拒绝要进行的操作</p><h4 id="流程："><a href="#流程：" class="headerlink" title="流程："></a>流程：</h4><p>​    当任务进入这个线程池 如果 此时核心数量还有空闲那么直接分配给核心。 如果核心数量满了则进入工作队列。如果工作也满了那么就去申请额外的线程保证总数量不超过最大线程数量。要是最大线程数量也满了那么就被拒绝。</p><blockquote><p>一般情况下，任务分为 10 密集型和计算密集型两种。计算密集型:吃 CPU，比如音视频处理、图像处理、数学计算等，一般是设置 corePoolSize 为CPU 的核数+1(空余线程)，可以让每个线程都能利用好 CPU 的每个核，而且线程之间不用频繁切换(减少打架、减少开销)<br> 10 密集型:吃带宽&#x2F;内存&#x2F;硬盘的读写资源，corePoolSize 可以设置大一点，一般经验值是 2n 左右，但是建议以 10 的能力为主。</p><h4 id="—by-yupi"><a href="#—by-yupi" class="headerlink" title="—by yupi"></a>—by yupi</h4></blockquote><h3 id="测试接口"><a href="#测试接口" class="headerlink" title="测试接口"></a>测试接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/queue&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Profile(&#123;&quot;dev&quot;,&quot;local&quot;&#125;)</span> <span class="comment">//只在本地测试环境生效</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="comment">// 自动注入一个线程池的实例</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolExecutor threadPoolExecutor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="comment">// 接收一个参数name，然后将任务添加到线程池中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="comment">// 使用CompletableFuture运行一个异步任务</span></span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 打印一条日志信息，包括任务名称和执行线程的名称</span></span><br><span class="line">            log.info(<span class="string">&quot;任务执行中：&quot;</span> + name + <span class="string">&quot;，执行人：&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 让线程休眠10分钟，模拟长时间运行的任务</span></span><br><span class="line">                Thread.sleep(<span class="number">60000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 异步任务在threadPoolExecutor中执行</span></span><br><span class="line">        &#125;, threadPoolExecutor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line">    <span class="comment">// 该方法返回线程池的状态信息</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个HashMap存储线程池的状态信息</span></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 获取线程池的队列长度</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> threadPoolExecutor.getQueue().size();</span><br><span class="line">        <span class="comment">// 将队列长度放入map中</span></span><br><span class="line">        map.put(<span class="string">&quot;队列长度&quot;</span>, size);</span><br><span class="line">        <span class="comment">// 获取线程池已接收的任务总数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">taskCount</span> <span class="operator">=</span> threadPoolExecutor.getTaskCount();</span><br><span class="line">        <span class="comment">// 将任务总数放入map中</span></span><br><span class="line">        map.put(<span class="string">&quot;任务总数&quot;</span>, taskCount);</span><br><span class="line">        <span class="comment">// 获取线程池已完成的任务数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">completedTaskCount</span> <span class="operator">=</span> threadPoolExecutor.getCompletedTaskCount();</span><br><span class="line">        <span class="comment">// 将已完成的任务数放入map中</span></span><br><span class="line">        map.put(<span class="string">&quot;已完成任务数&quot;</span>, completedTaskCount);</span><br><span class="line">        <span class="comment">// 获取线程池中正在执行任务的线程数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">activeCount</span> <span class="operator">=</span> threadPoolExecutor.getActiveCount();</span><br><span class="line">        <span class="comment">// 将正在工作的线程数放入map中</span></span><br><span class="line">        map.put(<span class="string">&quot;正在工作的线程数&quot;</span>, activeCount);</span><br><span class="line">        <span class="comment">// 将map转换为JSON字符串并返回</span></span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toJsonStr(map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DeepSeekResponseVO <span class="title function_">genChartByAiAsync</span><span class="params">(MultipartFile multipartFile, GenChartByAiRequest genChartByAiRequest, User loginUser)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> genChartByAiRequest.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">goal</span> <span class="operator">=</span> genChartByAiRequest.getGoal();</span><br><span class="line">        <span class="type">String</span> <span class="variable">chartType</span> <span class="operator">=</span> genChartByAiRequest.getChartType();</span><br><span class="line">        <span class="comment">//用户输入</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">userInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">userGoal</span> <span class="operator">=</span> goal;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(chartType))&#123;</span><br><span class="line">            userGoal+=<span class="string">&quot;请使用&quot;</span>+chartType;</span><br><span class="line">        &#125;</span><br><span class="line">        userInput.append(<span class="string">&quot;分析需求:&quot;</span>).append(userGoal).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">csvData</span> <span class="operator">=</span> ExcelUtils.excelToCsv(multipartFile);</span><br><span class="line">        userInput.append(<span class="string">&quot;原始目标:&quot;</span>).append(csvData).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存Chart</span></span><br><span class="line">        <span class="type">Chart</span> <span class="variable">chart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chart</span>();</span><br><span class="line">        chart.setGoal(goal);</span><br><span class="line">        chart.setName(name);</span><br><span class="line">        chart.setChartType(chartType);</span><br><span class="line">        <span class="comment">//先不返回</span></span><br><span class="line"><span class="comment">//        chart.setGenChart(genChart);</span></span><br><span class="line"><span class="comment">//        chart.setGenResult(genResult);</span></span><br><span class="line">        chart.setUserId(loginUser.getId());</span><br><span class="line">        <span class="comment">//设置为排队</span></span><br><span class="line">        chart.setStatus(<span class="string">&quot;wait&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">saveResult</span> <span class="operator">=</span> <span class="built_in">this</span>.save(chart);</span><br><span class="line">        ThrowUtils.throwIf(!saveResult, ErrorCode.SYSTEM_ERROR, <span class="string">&quot;图表保存失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建ChartData表Sql</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chartDataTableSql</span> <span class="operator">=</span> ChartTableUtils.ChartDataToTableSql(csvData,chart.getId());</span><br><span class="line">        <span class="comment">//防止sql注入</span></span><br><span class="line">        ThrowUtils.throwIf(SqlUtils.validSortField(chartDataTableSql),ErrorCode.PARAMS_ERROR,<span class="string">&quot;创建chartData表非法&quot;</span>);</span><br><span class="line">        <span class="comment">//创建表</span></span><br><span class="line">        chartMapper.createChartDataTable(chartDataTableSql);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//插入CharData数据Sql</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chartDataValueSql</span> <span class="operator">=</span> ChartTableUtils.ChartDataInsertTableSql(csvData,chart.getId());</span><br><span class="line">        <span class="comment">//防止sql注入</span></span><br><span class="line">        ThrowUtils.throwIf(SqlUtils.validSortField(chartDataValueSql),ErrorCode.PARAMS_ERROR,<span class="string">&quot;插入chartData数据非法&quot;</span>);</span><br><span class="line">        <span class="comment">//插入数据</span></span><br><span class="line">        chartMapper.insertChartData(chartDataValueSql);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//异步处理</span></span><br><span class="line">        <span class="comment">//使用deepseek获取结果</span></span><br><span class="line">        CompletableFuture.runAsync(()-&gt;&#123;</span><br><span class="line">            <span class="comment">//更新Chart数据库的Status 状态。从wait-&gt;running</span></span><br><span class="line">            <span class="type">Chart</span> <span class="variable">updatingChart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chart</span>();</span><br><span class="line">            updatingChart.setId(chart.getId());</span><br><span class="line">            <span class="comment">//修改状态</span></span><br><span class="line">            updatingChart.setStatus(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">updateStatusResult</span> <span class="operator">=</span> <span class="built_in">this</span>.updateById(updatingChart);</span><br><span class="line">            <span class="keyword">if</span>(!updateStatusResult)&#123;</span><br><span class="line">                handleChartUpdateError(chart.getId(),<span class="string">&quot;更新图表执行中状态失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> deepSeekService.callDeepSeek(userInput.toString());</span><br><span class="line">            String[] split = result.split(<span class="string">&quot;【【【【【&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(split.length&lt;<span class="number">3</span>)&#123;</span><br><span class="line">               handleChartUpdateError(chart.getId(),<span class="string">&quot;AI 生成错误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">genChart</span> <span class="operator">=</span> split[<span class="number">1</span>].trim();</span><br><span class="line">            <span class="type">String</span> <span class="variable">genResult</span> <span class="operator">=</span> split[<span class="number">2</span>].trim();</span><br><span class="line">            <span class="comment">//得到结果后，再更新一次</span></span><br><span class="line">            <span class="type">Chart</span> <span class="variable">updateChartResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chart</span>();</span><br><span class="line">            updateChartResult.setId(chart.getId());</span><br><span class="line">            updateChartResult.setStatus(<span class="string">&quot;succeed&quot;</span>);</span><br><span class="line">            updateChartResult.setGenChart(genChart);</span><br><span class="line">            updateChartResult.setGenResult(genResult);</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">updateResult</span> <span class="operator">=</span> <span class="built_in">this</span>.updateById(updateChartResult);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!updateResult)&#123;</span><br><span class="line">                handleChartUpdateError(chart.getId(),<span class="string">&quot;更新图表成功状态失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//返回VO结果</span></span><br><span class="line">        <span class="type">DeepSeekResponseVO</span>  <span class="variable">deepSeekResponseVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeepSeekResponseVO</span>();</span><br><span class="line">        deepSeekResponseVO.setChartId(chart.getId());</span><br><span class="line"><span class="comment">//        deepSeekResponseVO.setGenChart(chart.getGenChart());</span></span><br><span class="line"><span class="comment">//        deepSeekResponseVO.setGenResult(chart.getGenResult());</span></span><br><span class="line">        <span class="keyword">return</span> deepSeekResponseVO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleChartUpdateError</span><span class="params">(<span class="type">long</span> chartId,String execMessage)</span>&#123;</span><br><span class="line">        <span class="type">Chart</span> <span class="variable">updateChart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chart</span>();</span><br><span class="line">        updateChart.setId(chartId);</span><br><span class="line">        updateChart.setExecMessage(execMessage);</span><br><span class="line">        updateChart.setStatus(<span class="string">&quot;failed&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.updateById(updateChart);</span><br><span class="line">        ThrowUtils.throwIf(!result,ErrorCode.SYSTEM_ERROR,<span class="string">&quot;保存Chart执行消息失败&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!result)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;更新图表失败 &quot;</span>+chartId+ <span class="string">&quot; &quot;</span>+execMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO:"></a>TODO:</h3><p>​    \1. 当线程空闲时应该把被拒绝的请求完成。</p><p>​    \2. 超时控制，增加一个超时时间，如果超过这个时间则标记为失败。</p><p>​    3.反向压力：（通过AI服务当前任务队列数来控制核心数量）最大化利用资源<a href="https://zhuanlan.zhihu.com/p/404993753">反向压力 - 知乎</a></p>]]></content>
      
      
      <categories>
          
          <category> 智能BI项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多线程 </tag>
            
            <tag> 线程池 </tag>
            
            <tag> 队列 </tag>
            
            <tag> 异步化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>智能BI项目（四）分表和限流(令牌桶算法)</title>
      <link href="/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE%EF%BC%88%E5%9B%9B%EF%BC%89%E5%88%86%E8%A1%A8%E5%92%8C%E9%99%90%E6%B5%81-%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95/"/>
      <url>/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE%EF%BC%88%E5%9B%9B%EF%BC%89%E5%88%86%E8%A1%A8%E5%92%8C%E9%99%90%E6%B5%81-%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><p>​    没什么好说的就是新增了一个浏览我的图表的页面</p><p><img src="/%5Cimages%5Cpasted-3.png%5C" alt="upload successful">​编辑</p><h2 id="后端："><a href="#后端：" class="headerlink" title="后端："></a>后端：</h2><h3 id="分表设计"><a href="#分表设计" class="headerlink" title="分表设计!!"></a>分表设计!!</h3><p><img src="/%5Cimages%5Cpasted-4.png%5C" alt="upload successful">编辑</p><p>原来这个分表的设计有个从csv里的数据得到的chartData字段。但是这个东西数据量大起来就会很影响查询速度。所以把chartData分出来一个表<br> 每一个chartData都有一个chart_data_{charDataId}</p><p><img src="/%5Cimages%5Cpasted-5.png%5C" alt="upload successful">编辑</p><h3 id="好处："><a href="#好处：" class="headerlink" title="好处："></a>好处：</h3><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>​    \1. 如果需要data数据的某一行可以快速找到。</p><p>​    2.加快chart表的查询速度。互不影响增加安全性</p><h3 id="实现："><a href="#实现：" class="headerlink" title="实现："></a>实现：</h3><p>​    总共有三部分 创造动态新表，向新表插入数据，查询新表数据。</p><p><img src="/%5Cimages%5Cpasted-6.png%5C" alt="upload successful">编辑</p><p>直接用sql语句。(但是要小心sql注入需要校验一下)</p><h3 id="限流：面试必备：4种经典限流算法讲解最近我们系统引入了Guava的RateLimiter限流组件，它是基于令牌桶算法的实现的。-掘金"><a href="#限流：面试必备：4种经典限流算法讲解最近我们系统引入了Guava的RateLimiter限流组件，它是基于令牌桶算法的实现的。-掘金" class="headerlink" title="限流：面试必备：4种经典限流算法讲解最近我们系统引入了Guava的RateLimiter限流组件，它是基于令牌桶算法的实现的。 - 掘金"></a>限流：<a href="https://juejin.cn/post/6967742960540581918">面试必备：4种经典限流算法讲解最近我们系统引入了Guava的RateLimiter限流组件，它是基于令牌桶算法的实现的。 - 掘金</a></h3><p> 防止用户频繁操作。限制用户每分钟发送请求的次数。</p><p> 使用Redisson自带的限流方案</p><p><img src="/%5Cimages%5Cpasted-7.png%5C" alt="upload successful">编辑</p><h1 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h1><p>Redisson<strong>实现****令牌桶算法(trySetRate)</strong>。<br> 相当于<br> 有一个大鞋柜，大鞋柜里每个格子放了一双鞋子。<br> 当学生过来拿鞋子，会判断有没有柜子有没有鞋子，有的话就拿走。只有拿到鞋子的用户才有资格进入教室，没有拿到的不行。<br> 会有人一某种速率补充鞋子进鞋柜。比如一分钟补充5双直到补满。</p>]]></content>
      
      
      <categories>
          
          <category> 智能BI项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 令牌桶算法 </tag>
            
            <tag> 分表 </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>智能BI项目（二）前端登录和后端处理excel</title>
      <link href="/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%BA%8C%EF%BC%89%E5%89%8D%E7%AB%AF%E7%99%BB%E5%BD%95%E5%92%8C%E5%90%8E%E7%AB%AF%E5%A4%84%E7%90%86excel/"/>
      <url>/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%BA%8C%EF%BC%89%E5%89%8D%E7%AB%AF%E7%99%BB%E5%BD%95%E5%92%8C%E5%90%8E%E7%AB%AF%E5%A4%84%E7%90%86excel/</url>
      
        <content type="html"><![CDATA[<p>​<br>前端没什么好说的就是改几个图标文字什么的改成自己的。把请求登录时的数据前后端对应好就行。</p><p>后端使用了</p><p>MultipartFile去读取文件。</p><p>用</p><p>EasyExcel将xlsx转成List&lt;Map&lt;&gt;&gt;;EasyExcel实现Excel文件导入导出_easyexcel导出excel-CSDN博客</p><p>​</p>]]></content>
      
      
      <categories>
          
          <category> 智能BI项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> EasyExcel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>智能BI项目（一） 初始化前后端</title>
      <link href="/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%B8%80%EF%BC%89-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%89%8D%E5%90%8E%E7%AB%AF/"/>
      <url>/2025/07/14/%E6%99%BA%E8%83%BDBI%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%B8%80%EF%BC%89-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%89%8D%E5%90%8E%E7%AB%AF/</url>
      
        <content type="html"><![CDATA[<p>跟着yupi开始学习新项目。<br> 搞这个初始化项目就搞了一晚上。折腾死了</p><p> BI项目– 根据传入的数据前端生成图表。加个智能其实也就是用ai更方便用户。提高效率。</p><h2 id="技术栈："><a href="#技术栈：" class="headerlink" title="技术栈："></a>技术栈：</h2><h5 id="前端："><a href="#前端：" class="headerlink" title="前端："></a>前端：</h5><ol><li><h5 id="react"><a href="#react" class="headerlink" title="react"></a>react</h5></li><li><h5 id="开发框架：Umi-AntDesign-Pro"><a href="#开发框架：Umi-AntDesign-Pro" class="headerlink" title="开发框架：Umi + AntDesign Pro"></a>开发框架：Umi + AntDesign Pro</h5></li><li><p>​     可视化开发库（Echarts + HighCharts +AntV）</p></li><li><p>​    umi OpeanApi (自动生成后端API接口代码。利用后端的swagger</p></li></ol><h4 id="后端："><a href="#后端：" class="headerlink" title="后端："></a>后端：</h4><ol><li>spring boot(用模板开发省时省力)</li><li>MySQL</li><li>MyBatis Plus</li><li>RabbitMQ</li><li>AI 接口</li><li>Excel上传和解析(Easy Excel)</li><li>Swagger + Knife4j (项目接口文档)</li><li>Hutool工具库</li></ol><h2 id="前端快速开始-：开始使用-Ant-Design-Pro"><a href="#前端快速开始-：开始使用-Ant-Design-Pro" class="headerlink" title="前端快速开始 ：开始使用 - Ant Design Pro"></a>前端快速开始 ：<a href="https://pro.ant.design/zh-CN/docs/getting-started/">开始使用 - Ant Design Pro</a></h2><h2 id="后端快速开始：使用yupi的模板。"><a href="#后端快速开始：使用yupi的模板。" class="headerlink" title="后端快速开始：使用yupi的模板。"></a>后端快速开始：使用yupi的模板。</h2><h2 id="初始化过程中学到了：前端快速开始和前端可以使用openAPI-结合-swagger来快速生成调用接口方法。"><a href="#初始化过程中学到了：前端快速开始和前端可以使用openAPI-结合-swagger来快速生成调用接口方法。" class="headerlink" title="初始化过程中学到了：前端快速开始和前端可以使用openAPI 结合 swagger来快速生成调用接口方法。"></a>初始化过程中学到了：前端快速开始和前端可以使用openAPI 结合 swagger来快速生成调用接口方法。</h2>]]></content>
      
      
      <categories>
          
          <category> 智能BI项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> init </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>伙伴匹配系统(七) 分布式锁 Redisson 和看门狗机制</title>
      <link href="/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E4%B8%83-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-Redisson-%E5%92%8C%E7%9C%8B%E9%97%A8%E7%8B%97%E6%9C%BA%E5%88%B6/"/>
      <url>/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E4%B8%83-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-Redisson-%E5%92%8C%E7%9C%8B%E9%97%A8%E7%8B%97%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<p> 在多机环境下要想控制某段程序所需要的执行机子需要给定义一个或者多个锁。来让不同的机子去抢锁只有抢到锁的程序才执行。例如定时任务插入数据，如果没有锁那么原本只需要插入100条数据在3台服务器上就会插入300条。</p><p>方法类似于多线程的Lock但是多线程实在本地一台服务器执行，分布式锁是在多台服务器执行。本地一台的Lock无法被其他的服务器识别到</p><p>解决方法：用数据库设置一个字段例如lock,当一个程序进入判断这个字段是否为空，如果为空那么就填入字段执行完毕后释放。</p><h1 id="用Redis实现"><a href="#用Redis实现" class="headerlink" title="用Redis实现"></a>用Redis实现</h1><p>注意事项:</p><p>1.用完锁要释放</p><p>2.锁要加过期时间（如果程序异常终止了，那么字段就会一直存在）。</p><p>3.如果方法执行时间太长超过了锁设置的过期时间</p><p>​    问题：</p><p>​    1.提前释放之后下一个服务提前进来,但程序还未执行结束.</p><p>​    2.连锁效应：第二个方法进来运行时第一个方法执行结束delete了锁此时锁的value为空，第        三个服务也进来了。</p><p>​     解决方案：</p><p>​    续期 ：在方法执行过程中给其续期。</p><p> 4.释放锁时，会先判断是否为自己的锁，再进行删除，但是判断完是否是自己的锁时锁过期，此时再进来一个B方法的锁，执行delete方法会把B删除。</p><p>​    解决方法：使用原子操作：Redis+lua脚本。</p><p>可以使用Redisson解决以上问题</p><h1 id="Redisson-实现分布锁"><a href="#Redisson-实现分布锁" class="headerlink" title="Redisson 实现分布锁"></a>Redisson 实现分布锁</h1><p><strong>Redisson 是一个java操作redis的客户端，提供了大量的分布式数据集来简化对Redis的操作和使用，让开发者像使用本地集合一样使用Redis，完全感受不到Redis存在</strong></p><p>Redisson配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span>: RedissonConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ZH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2024/12/1 16:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;spring.redis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">redisAddress</span> <span class="operator">=</span> String.format(<span class="string">&quot;redis://%s:%s&quot;</span>, host, port);</span><br><span class="line">        config.useSingleServer().setAddress(redisAddress).setDatabase(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">// Sync and Async API</span></span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">        <span class="keyword">return</span> redisson;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="看门狗-—watch-dog"><a href="#看门狗-—watch-dog" class="headerlink" title="看门狗 —watch dog"></a>看门狗 —watch dog</h1><p>redisson解决了程序运行时间过长导致value过期问题，利用watch dog看门狗机制隔一段时间重新生成一段新的锁</p><p><a href="https://blog.csdn.net/m0_56088675/article/details/143817678">Redisson 的 Watch Dog机制_redisson 检查锁的间隔-CSDN博客</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 25 * * * *&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doCacheRecommendUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;zh:preCacheJob:doCache:lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">/*-1代表releasetime 默认30s时效每隔10s检测一次检测到还在执行就重置回30s如果加了时间，那么他不会自动刷新*/</span></span><br><span class="line">            <span class="keyword">if</span>(lock.tryLock(<span class="number">0</span>,-<span class="number">1</span>,TimeUnit.MILLISECONDS))&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;定时任务执行&quot;</span>);</span><br><span class="line">               <span class="comment">// sleep(1000000);</span></span><br><span class="line">                importantUserIds.forEach(id-&gt;&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">strKey</span> <span class="operator">=</span> String.format(<span class="string">&quot;user:recommend:%d&quot;</span>,id);</span><br><span class="line">                    <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">                    <span class="type">QueryWrapper</span> <span class="variable">queryWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">                    Page&lt;User&gt; userList1 = (Page&lt;User&gt;) userService.page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;( <span class="number">1</span>,<span class="number">20</span>),queryWrapper);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        valueOperations.set(strKey,userList1,<span class="number">300000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;redis存储失败&quot;</span>,e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;doCacheRecommendUser error:&quot;</span>,e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放自己的锁</span></span><br><span class="line">            <span class="keyword">if</span>(lock.isHeldByCurrentThread())&#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
      
      
      <categories>
          
          <category> 伙伴匹配系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分布式 </tag>
            
            <tag> redis </tag>
            
            <tag> redisson </tag>
            
            <tag> 看门狗机制 </tag>
            
            <tag> 分布式锁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>伙伴匹配系统(六)（多线程并发）</title>
      <link href="/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%85%AD-%EF%BC%88%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%B9%B6%E5%8F%91/"/>
      <url>/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%85%AD-%EF%BC%88%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%B9%B6%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h1 id="多线程并发"><a href="#多线程并发" class="headerlink" title="多线程并发"></a>多线程并发</h1><p><a href="https://liaoxuefeng.com/books/java/threading/index.html">多线程 - Java教程 - 廖雪峰的官方网站</a></p><p>在批量插入假用户的时候需要插入1000条数据，通过for循环线性插入时间效率太低了。</p><p>所以引入多线程来实现并发。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Service.saveBatch(userList,10000);</span><br></pre></td></tr></table></figure><p>在插入数据库时可以用service自带的saveBatch来实现</p><p>在创建新数据并导入时也可以用多线程去创建。</p><p>实现方法分n组去创建将每组创建得到的userList去保存到数据库。n组数据并发执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">MAX_NUMBER</span> <span class="operator">=</span> <span class="number">100000L</span>;</span><br><span class="line">    stopWatch.start();</span><br><span class="line">    List&lt;CompletableFuture&lt;Void&gt;&gt; futureList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;User&gt; userList = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//并发执行</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(()-&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; MAX_NUMBER; j++) &#123;</span><br><span class="line">                    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">                    user.setUsername(<span class="string">&quot;zh&quot;</span> + j);</span><br><span class="line">                    user.setUserAccount(Long.toString(MyCommonUtils.randNumber(<span class="number">10</span>)));</span><br><span class="line">                    user.setAvatarUrl(<span class="string">&quot;../../src/img/avatar/mari.jpg&quot;</span>);</span><br><span class="line">                    user.setGender((MyCommonUtils.randNumber(<span class="number">2</span>) % <span class="number">2</span> == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>));</span><br><span class="line">                    user.setUserPassword(<span class="string">&quot;123456789&quot;</span>);</span><br><span class="line">                    user.setPhone(Long.toString(MyCommonUtils.randNumber(<span class="number">10</span>)));</span><br><span class="line">                    user.setEmail(Long.toString(MyCommonUtils.randNumber(<span class="number">10</span>)) + <span class="string">&quot;@qq.com&quot;</span>);</span><br><span class="line">                    user.setUserStatus(<span class="number">0</span>);</span><br><span class="line">                    user.setIsDelete(<span class="number">0</span>);</span><br><span class="line">                    user.setUserRole(<span class="number">0</span>);</span><br><span class="line">                    user.setUserCode(<span class="string">&quot;123456789&quot;</span>);</span><br><span class="line">                    user.setTags(<span class="string">&quot;[]&quot;</span>);</span><br><span class="line">                    user.setProfile(<span class="string">&quot;这个人很懒&quot;</span>);</span><br><span class="line">                    userList.add(user);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                userService.saveBatch(userList,<span class="number">10000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        futureList.add(future);</span><br><span class="line">    &#125;</span><br><span class="line">    CompletableFuture.allOf(futureList.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[]&#123;&#125;)).join();</span><br><span class="line">    stopWatch.stop();</span><br><span class="line">    System.out.println(stopWatch.getTotalTimeMillis());</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h1 id="优化"><a href="#优化" class="headerlink" title="优化-&gt;"></a>优化-&gt;</h1><p>既然能分成n组那么就可以分成n+1,n+2…n+x组所以可以利用二分的思想将其分到你想要的大小进行分块多线程并发。</p><p>用到了forkjoin</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StopWatch</span> <span class="variable">stopWatch1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">stopWatch1.start();</span><br><span class="line">ForkJoinTask&lt;Integer&gt; task = <span class="keyword">new</span> <span class="title class_">AddUser</span>(<span class="number">1</span>,<span class="number">100000</span>);</span><br><span class="line">ForkJoinPool.commonPool().invoke(task);</span><br><span class="line">stopWatch1.stop();</span><br><span class="line">System.out.println(stopWatch1.getTotalTimeMillis());</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.model.domain.User;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveTask;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddUser</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AddUser addUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        addUser = <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THRESHOLD</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line">    <span class="type">int</span> start;</span><br><span class="line">    <span class="type">int</span> end;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AddUser</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AddUser</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(start&gt;end) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (end - start &lt;= THRESHOLD) &#123;</span><br><span class="line">            List&lt;User&gt;userList = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=end-start;i++)&#123;</span><br><span class="line">                <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">                user.setUsername(<span class="string">&quot;zh&quot;</span>+ start+i);</span><br><span class="line">                user.setUserAccount(Long.toString(MyCommonUtils.randNumber(<span class="number">10</span>)));</span><br><span class="line">                user.setAvatarUrl(<span class="string">&quot;../../src/img/avatar/mari.jpg&quot;</span>);</span><br><span class="line">                user.setGender((MyCommonUtils.randNumber(<span class="number">2</span>)%<span class="number">2</span>==<span class="number">0</span>?<span class="number">1</span>:<span class="number">0</span>));</span><br><span class="line">                user.setUserPassword(<span class="string">&quot;123456789&quot;</span>);</span><br><span class="line">                user.setPhone(Long.toString(MyCommonUtils.randNumber(<span class="number">10</span>)));</span><br><span class="line">                user.setEmail(Long.toString(MyCommonUtils.randNumber(<span class="number">10</span>))+<span class="string">&quot;@qq.com&quot;</span>);</span><br><span class="line">                user.setUserStatus(<span class="number">0</span>);</span><br><span class="line">                user.setIsDelete(<span class="number">0</span>);</span><br><span class="line">                user.setUserRole(<span class="number">0</span>);</span><br><span class="line">                user.setUserCode(<span class="string">&quot;123456789&quot;</span>);</span><br><span class="line">                user.setTags(<span class="string">&quot;[]&quot;</span>);</span><br><span class="line">                user.setProfile(<span class="string">&quot;这个人很懒&quot;</span>);</span><br><span class="line">                userList.add(user);</span><br><span class="line">            &#125;</span><br><span class="line">            addUser.userService.saveBatch(userList, Math.max(userList.size()/<span class="number">10</span>,<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 任务太大,一分为二:</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">middle</span> <span class="operator">=</span> (end + start) / <span class="number">2</span>;</span><br><span class="line"><span class="comment">//        System.out.println(String.format(&quot;split %d~%d ==&gt; %d~%d, %d~%d&quot;, start, end, start, middle, middle, end));</span></span><br><span class="line">         AddUser addUser1= <span class="keyword">new</span> <span class="title class_">AddUser</span>(start, middle);</span><br><span class="line">        <span class="type">AddUser</span> <span class="variable">addUser2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddUser</span>(middle+<span class="number">1</span>, end);</span><br><span class="line">        invokeAll(addUser1, addUser2);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>线程池开启配置可以通过</p><p>public ThreadPoolExecutor(int corePoolSize,<br>                int maximumPoolSize,<br>                long keepAliveTime,<br>                TimeUnit unit,<br>                BlockingQueue<Runnable> workQueue,<br>                ThreadFactory threadFactory,<br>                RejectedExecutionHandler handler)</p><p>去配置<a href="https://www.cnblogs.com/simpleDi/p/11342440.html">ExecutorService 线程池详解 - simpleDi - 博客园</a></p>]]></content>
      
      
      <categories>
          
          <category> 伙伴匹配系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多线程 </tag>
            
            <tag> 并发 </tag>
            
            <tag> 线程池 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>伙伴匹配系统(五)假数据批量插入</title>
      <link href="/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E4%BA%94/"/>
      <url>/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E4%BA%94/</url>
      
        <content type="html"><![CDATA[<p>​<br>假数据批量插入与定时任务.</p><p><img src="/%5Cimages%5Cpasted-2.png%5C" alt="upload successful"><br>在插入批量大数据时需要开启定时任务分批次插入在springboot 启动项可以添加一个</p><p>@EnableScheduling 注解代表可以开启定时任务。<br>批量优化<br>1 可以使用myBatisplus自带的</p><p>userService.saveBatch(userList,100);<br>进行批量插入</p><p>​</p>]]></content>
      
      
      <categories>
          
          <category> 伙伴匹配系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 定时任务 </tag>
            
            <tag> 插入假数据 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>伙伴匹配系统(四) 分布式登录</title>
      <link href="/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%9B%9B/"/>
      <url>/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E5%9B%9B/</url>
      
        <content type="html"><![CDATA[<p>​<br>Session 多机登录实现分布式登录<br> <br>Session 存储在一个domin路径下,但是调用不同的服务器不会功享保存的Session值。Session里包含了用户信息等内容所以要吧Session保存到Redis里边并让服务器从相同的Redis里去调用。实现分布式登录</p><p>Redis 安装与配置<br>5版本：Releases · tporadowski&#x2F;redis 下载.msi傻瓜式安装<br>在maven仓库中找到spring boot starter data redis  与springboot版本差不多。</p><p>可以下载quickRedis操作管理Redis</p><p>将Session传入Redis中的工具<br>在maven仓库中找到spring-session-data-redis 与springboot 差不多版本</p><p>配置xml</p><p><img src="/%5Cimages%5Cpasted-1.png%5C" alt="upload successful"></p><p>​</p>]]></content>
      
      
      <categories>
          
          <category> 伙伴匹配系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分布式 </tag>
            
            <tag> redis </tag>
            
            <tag> session </tag>
            
            <tag> 分布式登录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>伙伴匹配系统(三)(axios请求，controller注解，vue OnMounted)</title>
      <link href="/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E4%B8%89-axios%E8%AF%B7%E6%B1%82%EF%BC%8Ccontroller%E6%B3%A8%E8%A7%A3%EF%BC%8Cvue-OnMounted/"/>
      <url>/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E4%B8%89-axios%E8%AF%B7%E6%B1%82%EF%BC%8Ccontroller%E6%B3%A8%E8%A7%A3%EF%BC%8Cvue-OnMounted/</url>
      
        <content type="html"><![CDATA[<p>防盗链referer</p><p>开启防盗链可以让其他网站加载不出他的网站的图片</p><p>防盗链referer详解和解决办法_referer防盗链原理-CSDN博客</p><p>Controller层返回对象问题</p><p>传统@controller注解返回对象是视图对象<br>@ResponseBody详解-CSDN博客在方法上加个@ResponseBody的注解即可返回JSON格式或者其他类型，或者直接将@Controller换成@RestController<br>@RestController &#x3D; @ResponsBody+@Controller</p><p>前端onMounted 生命周期钩子</p><p>在vue3中的setup里生命或者调用函数这个函数会在组件初始化之前运行使用onMounted 会在组件的DOM加载完后再调用<br>Vue 3 里的 onMounted 怎么用？_vue3 onmounted-CSDN博客 </p><p>axios get请求传入数组<br>一般axios的get方法，但是传入数组会有a[]&#x3D;1&amp;a[]&#x3D;2和controller层所需要的格式不同<br>可以引入qs库可以改变他的输入方式<br>axios请求传递数组 paramsSerializer序列化-CSDN博客</p><p>​</p>]]></content>
      
      
      <categories>
          
          <category> 伙伴匹配系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>伙伴匹配系统(二)前端学习</title>
      <link href="/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E4%BA%8C-%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0/"/>
      <url>/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F-%E4%BA%8C-%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>1.router 和 route的区别。</p><p>router 用于跳转，传参等</p><p>route用于得到数据。</p><p>2.Vue中常用的数组方法.filter()、.map()、.forEach()、.find()、.findIndex()、.some()、.every()</p><p><a href="https://blog.csdn.net/wang_xiao_ye/article/details/89385023">Vue中常用的数组方法.filter()、.map()、.forEach()、.find()、.findIndex()、.some()、.every()_vue中的a.filter()方法-CSDN博客</a></p><p>3.扩展语言a&#x3D;[…b]代表将b赋值给a，a&#x3D;[…b,..c]代表a包括了b,c</p><p>[深入理解 JavaScript 的【扩展运算符】【…】（Spread Operator）-CSDN博客](<a href="https://blog.csdn.net/jhgj56/article/details/143232852#:~:text=%E5%9C%A8">https://blog.csdn.net/jhgj56/article/details/143232852#:~:text=在</a> JavaScript 中， 扩展运算符 （…）是一种非常强大且 灵活的 语法，可以简化数组和对象的操作。 本文将详细介绍扩展运算符的基本用法、应用场景及其背后的原理。,什么是扩展运算符？ 扩展运算符（spread operator）是 ES6 （ECMAScript 2015）引入的一项特性，用于将数组或对象拆分成单独的元素或属性。 它的语法非常简单，只需在表达式前面添加三个点 …。)</p>]]></content>
      
      
      <categories>
          
          <category> 伙伴匹配系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
            <tag> 前端 </tag>
            
            <tag> route </tag>
            
            <tag> router </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>伙伴匹配系统后端开发(一)框架搭建</title>
      <link href="/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91-%E4%B8%80-%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/"/>
      <url>/2025/07/14/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91-%E4%B8%80-%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<p>1.通过mybatisX generate 构造器去自动构造类.</p><p>\2. 学习了java enum(枚举类)<a href="https://liaoxuefeng.com/books/java/oop/core/enum/index.html">枚举类 - Java教程 - 廖雪峰的官方网站</a></p><p>可以不需要声明很多东西，减少了代码复杂度.</p><p>3学习了 throw RuntimeException (抛异常)<br> 在运行中遇到的异常如数组越界等都可以用throw RuntimeException 来处理.</p><p>4.QueryWrapper 条件构造器<a href="https://blog.csdn.net/bird_tp/article/details/105587582">mybatis plus 条件构造器queryWrapper学习_querywapper是什么-CSDN博客</a></p><p>可以直接在这里添加条件不需要再用Mapper.xml里面重新写一遍,更加的快速。</p><p>5.Gson (json字符串和类互相转换)</p><p><a href="https://blog.csdn.net/qq_40163677/article/details/112412623">Gson的基本使用_gson使用-CSDN博客</a></p><p>6.使用了<code>Optional</code>类来处理可能为<code>null的值</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tagNameSet = Optional.ofNullable(tagNameSet).orElse(new HashSet&lt;&gt;());</span><br></pre></td></tr></table></figure><p>处理这个Set是否为空的情况如果tagNameSet为null则返回Optional对象，<code>orElse</code>方法用于处理<code>tagNameSet</code>可能为<code>null</code>的情况。如果<code>tagNameSet</code>为<code>null</code>，则<code>Optional.ofNullable(tagNameSet)</code>会返回一个空的<code>Optional</code>对象，随后调用<code>orElse(new HashSet&lt;&gt;())</code>会返回一个新的<code>HashSet</code>实例作为默认值。如果不为空就将tagNameSet往里赋值。</p><p>7.List.stream().filter 将list里面的参数筛选里面可以通过写逻辑判断函数来得到想要的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">return userList.stream().filter(user -&gt;&#123;</span><br><span class="line">     //条件 return false</span><br><span class="line">    return true;</span><br><span class="line">&#125;).map(this::getSafetyUser).collect(Collectors.toList());</span><br></pre></td></tr></table></figure><p>.map（this::getSafetyUser）可以存到map里得到安全的safetyUser。</p><p>.collect(Collectors.toList()); 转换成list</p>]]></content>
      
      
      <categories>
          
          <category> 伙伴匹配系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> init </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2025/07/11/hello-world/"/>
      <url>/2025/07/11/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start1"><a href="#Quick-Start1" class="headerlink" title="Quick Start1"></a>Quick Start1</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title>分类</title>
      <link href="/categories/index.html"/>
      <url>/categories/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>标签</title>
      <link href="/tags/index.html"/>
      <url>/tags/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
  
</search>
